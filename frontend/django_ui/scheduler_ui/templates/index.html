<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Timetable Generator - Configuration</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Exam Timetable Generator</h1>
            <nav>
                <a href="/" class="active">Configuration</a>
                <a href="/groups/">Groups</a>
                <a href="/generate/">Generate</a>
            </nav>
        </header>

        <main>
            <h2>System Configuration</h2>
            
            <form id="configForm">
                <div class="form-section">
                    <h3>Time Configuration</h3>
                    <div class="form-group">
                        <label for="days">Number of Days:</label>
                        <input type="number" id="days" name="days" min="1" max="30" value="5" required>
                    </div>
                    <div class="form-group">
                        <label for="slotsPerDay">Slots Per Day:</label>
                        <input type="number" id="slotsPerDay" name="slotsPerDay" min="1" max="10" value="2" required>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Subjects</h3>
                    <div class="form-group">
                        <label for="subjects">Subjects (comma-separated):</label>
                        <textarea id="subjects" name="subjects" rows="4" required
                            placeholder="Math, Physics, Chemistry, English, Biology">Math, Physics, Chemistry, English</textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Halls Configuration</h3>
                    <div id="hallsList">
                        <div class="hall-item">
                            <input type="text" class="hall-name" placeholder="Hall Name" value="Hall-1" required>
                            <input type="number" class="hall-capacity" placeholder="Capacity" value="60" min="1" required>
                            <button type="button" class="btn-remove" onclick="removeHall(this)">Remove</button>
                        </div>
                        <div class="hall-item">
                            <input type="text" class="hall-name" placeholder="Hall Name" value="Hall-2" required>
                            <input type="number" class="hall-capacity" placeholder="Capacity" value="60" min="1" required>
                            <button type="button" class="btn-remove" onclick="removeHall(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn-secondary" onclick="addHall()">Add Hall</button>
                </div>

                <div class="form-section">
                    <h3>Allocation Settings</h3>
                    <div class="form-group">
                        <label for="perSubjectLimit">Per-Subject Limit in Hall:</label>
                        <input type="number" id="perSubjectLimit" name="perSubjectLimit" min="1" value="30" required>
                    </div>
                    <div class="form-group">
                        <label for="randomSeed">Random Seed (optional):</label>
                        <input type="number" id="randomSeed" name="randomSeed" placeholder="Leave empty for random">
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn-primary">Save Configuration</button>
                </div>
            </form>

            <div id="message" class="message"></div>
        </main>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';

        function addHall() {
            const hallsList = document.getElementById('hallsList');
            const hallItem = document.createElement('div');
            hallItem.className = 'hall-item';
            hallItem.innerHTML = `
                <input type="text" class="hall-name" placeholder="Hall Name" required>
                <input type="number" class="hall-capacity" placeholder="Capacity" min="1" required>
                <button type="button" class="btn-remove" onclick="removeHall(this)">Remove</button>
            `;
            hallsList.appendChild(hallItem);
        }

        function removeHall(button) {
            const hallsList = document.getElementById('hallsList');
            if (hallsList.children.length > 1) {
                button.parentElement.remove();
            } else {
                showMessage('At least one hall is required', 'error');
            }
        }

        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            setTimeout(() => {
                messageDiv.className = 'message';
            }, 5000);
        }

        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const days = parseInt(document.getElementById('days').value);
            const slotsPerDay = parseInt(document.getElementById('slotsPerDay').value);
            const subjectsText = document.getElementById('subjects').value;
            const subjects = subjectsText.split(',').map(s => s.trim()).filter(s => s);
            const perSubjectLimit = parseInt(document.getElementById('perSubjectLimit').value);
            const randomSeed = document.getElementById('randomSeed').value;

            // Collect halls
            const hallItems = document.querySelectorAll('.hall-item');
            const halls = [];
            for (const item of hallItems) {
                const name = item.querySelector('.hall-name').value.trim();
                const capacity = parseInt(item.querySelector('.hall-capacity').value);
                if (name && capacity > 0) {
                    halls.push({ name, capacity });
                }
            }

            if (halls.length === 0) {
                showMessage('At least one hall is required', 'error');
                return;
            }

            if (subjects.length === 0) {
                showMessage('At least one subject is required', 'error');
                return;
            }

            const configData = {
                subjects,
                groups: [],  // Will be added on groups page
                days,
                slots_per_day: slotsPerDay,
                halls,
                per_subject_limit: perSubjectLimit,
                random_seed: randomSeed ? parseInt(randomSeed) : null
            };

            try {
                const response = await fetch(`${API_URL}/api/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });

                if (response.ok) {
                    showMessage('Configuration saved successfully!', 'success');
                } else {
                    const error = await response.json();
                    // Handle different error formats
                    let errorMessage = 'Unknown error';
                    if (typeof error.detail === 'string') {
                        errorMessage = error.detail;
                    } else if (Array.isArray(error.detail)) {
                        // Pydantic validation errors
                        errorMessage = error.detail.map(e => `${e.loc.join('.')}: ${e.msg}`).join('; ');
                    } else if (error.detail && typeof error.detail === 'object') {
                        errorMessage = JSON.stringify(error.detail);
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    showMessage(`Error: ${errorMessage}`, 'error');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            }
        });

        // Load existing configuration on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_URL}/api/config`);
                if (response.ok) {
                    const config = await response.json();
                    if (config.days) {
                        document.getElementById('days').value = config.days;
                        document.getElementById('slotsPerDay').value = config.slots_per_day;
                        document.getElementById('perSubjectLimit').value = config.per_subject_limit;
                        if (config.subjects && config.subjects.length > 0) {
                            document.getElementById('subjects').value = config.subjects.join(', ');
                        }
                        if (config.random_seed) {
                            document.getElementById('randomSeed').value = config.random_seed;
                        }
                        
                        // Load halls
                        if (config.halls && config.halls.length > 0) {
                            const hallsList = document.getElementById('hallsList');
                            hallsList.innerHTML = '';
                            config.halls.forEach(hall => {
                                const hallItem = document.createElement('div');
                                hallItem.className = 'hall-item';
                                hallItem.innerHTML = `
                                    <input type="text" class="hall-name" placeholder="Hall Name" value="${hall.name}" required>
                                    <input type="number" class="hall-capacity" placeholder="Capacity" value="${hall.capacity}" min="1" required>
                                    <button type="button" class="btn-remove" onclick="removeHall(this)">Remove</button>
                                `;
                                hallsList.appendChild(hallItem);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading configuration:', error);
            }
        });
    </script>
</body>
</html>
